<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>红绿灯，停！</title>
</head>

<body>
    <button id="start">开始</button>
    <button id="pause">暂停</button>
    <div id="status"></div>
    <script>
        const statusBox = document.getElementById('status');
        const sleep = (ms, singal) => new Promise((resolve, reject) => {
            const timer = setTimeout(resolve, ms);
            singal.addEventListener('abort', () => {
                clearTimeout(timer);
                reject(new DOMException('Aborted', 'AbortError'));
            }, { once: true })//evenntmitter 订阅发布者模式 只执行一次
        })
        const req = [
            { color: '红', time: 3000 },
            { color: '黄', time: 1000 },
            { color: '绿', time: 3000 }
        ]
        let controller = null
        async function trafficLight(singal) {
            while (!singal.aborted) {
                for (const { color, time } of req) {
                    if (singal.aborted) return
                    console.log(color);
                    statusBox.textContent = color;
                    try {
                        await sleep(time, singal)
                    }
                    catch (e) {
                        if (e.name === 'AbortError') return
                        throw e
                    }
                }
            }
        }
        document.getElementById('start').addEventListener('click', () => {
            if (controller && controller.signal.aborted) return
            controller = new AbortController()
            trafficLight(controller.signal)
        })
        document.getElementById('pause').addEventListener('click', () => {
            if (controller) controller.abort()
        })
    </script>
</body>

</html>