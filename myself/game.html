<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>碰碰球游戏场</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            background: #f0f0f0;
        }

        #game-container {
            width: 80vw;
            height: 80vh;
            background: white;
            border: 2px solid #333;
            border-radius: 10px;
            box-shadow: 0 0 20px rgba(0,0,0,0.1);
        }
    </style>
</head>
<body>
    <div id="game-container">
        <div class="balls-container player-balls">
            <div class="ball red"></div>
            <div class="ball yellow"></div>
            <div class="ball blue"></div>
        </div>
        <div class="balls-container ai-balls">
            <div class="ball cyan"></div>
            <div class="ball navy"></div>
            <div class="ball purple"></div>
        </div>
    </div>
    
    <style>
        #game-container {
            position: relative;
            width: 80vw;
            height: 80vh;
            background: white;
            border: 2px solid #333;
            border-radius: 10px;
            box-shadow: 0 0 20px rgba(0,0,0,0.1);
        }

        .balls-container {
            position: absolute;
            top: 30%;
            display: flex;
            flex-direction: column;
            gap: 40px;
        }

        .player-balls {
            left: 10px;
        }

        .ai-balls {
            right: 10px;
        }

        .ball {
            position: absolute;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            box-shadow: 0 3px 6px rgba(0,0,0,0.2);
            transition: transform 0.3s ease;
        }

        .ball:hover {
            transform: scale(1.2);
        }

        .red { background: #ff4757; }
        .yellow { background: #ffd32a; }
        .blue { background: #1e90ff; }
        .cyan { background: #00d8d6; }
        .navy { background: #3d3dff; }
        .purple { background: #6c5ce7; }
    </style>

<script>
const balls = document.querySelectorAll('.ball');
const container = document.getElementById('game-container');
const rect = container.getBoundingClientRect();
const ELASTICITY = 0.8;

let dragBall = null;
let startX, startY;
let offsetX = 0, offsetY = 0;

// 物理参数
const ballStates = new Map();
balls.forEach(ball => {
    ballStates.set(ball, {
        x: parseFloat(ball.style.left) || 0,
        y: parseFloat(ball.style.top) || 0,
        vx: 0,
        vy: 0,
        radius: ball.offsetWidth / 2,
        moving: false
    });
});

// 鼠标事件
container.addEventListener('mousedown', e => {
    const ball = e.target.closest('.ball');
    if (ball && !ballStates.get(ball).moving) {
        dragBall = ball;
        const rect = ball.getBoundingClientRect();
        startX = e.clientX - rect.left;
        startY = e.clientY - rect.top;
        ball.style.cursor = 'grabbing';
    }
});

document.addEventListener('mousemove', e => {
    if (!dragBall) return;
    
    offsetX = e.clientX - startX - rect.left;
    offsetY = e.clientY - startY - rect.top;
    
    // 限制在容器内
    offsetX = Math.max(0, Math.min(offsetX, rect.width - dragBall.offsetWidth));
    offsetY = Math.max(0, Math.min(offsetY, rect.height - dragBall.offsetHeight));
    
    dragBall.style.left = offsetX + 'px';
    dragBall.style.top = offsetY + 'px';
});

document.addEventListener('mouseup', () => {
    if (!dragBall) return;
    
    const state = ballStates.get(dragBall);
    state.vx = (offsetX - state.x) * 0.5;
    state.vy = (offsetY - state.y) * 0.5;
    state.moving = true;
    
    dragBall.style.cursor = 'grab';
    dragBall = null;
    
    requestAnimationFrame(update);
});

document.addEventListener('DOMContentLoaded', () => {
    const container = document.getElementById('game-container');
    let rect = container.getBoundingClientRect();
    
    // 初始化小球位置
    document.querySelectorAll('.balls-container').forEach(container => {
        Array.from(container.children).forEach((ball, index) => {
            ball.style.left = '0px';
            ball.style.top = `${index * 60}px`;
        });
    });

    // 修改mousemove事件处理
    document.addEventListener('mousemove', e => {
        if (!dragBall) return;
        
        // 实时获取最新容器尺寸
        rect = container.getBoundingClientRect();
        
        offsetX = e.clientX - startX - rect.left;
        offsetY = e.clientY - startY - rect.top;
        
        // 添加10px的边界缓冲
        offsetX = Math.max(-10, Math.min(offsetX, rect.width - dragBall.offsetWidth + 10));
        offsetY = Math.max(-10, Math.min(offsetY, rect.height - dragBall.offsetHeight + 10));
        
        dragBall.style.left = offsetX + 'px';
        dragBall.style.top = offsetY + 'px';
    });
});

function update() {
    let needUpdate = false;
    
    ballStates.forEach((state, ball) => {
        if (!state.moving) return;
        
        state.x += state.vx;
        state.y += state.vy;
        
        // 边界碰撞
        if (state.x <= 0 || state.x >= rect.width - state.radius*2) {
            state.vx *= -ELASTICITY;
            state.x = Math.max(0, Math.min(state.x, rect.width - state.radius*2));
        }
        if (state.y <= 0 || state.y >= rect.height - state.radius*2) {
            state.vy *= -ELASTICITY;
            state.y = Math.max(0, Math.min(state.y, rect.height - state.radius*2));
        }
        
        // 速度衰减
        state.vx *= 0.99;
        state.vy *= 0.99;
        
        if (Math.abs(state.vx) < 0.1 && Math.abs(state.vy) < 0.1) {
            state.moving = false;
        } else {
            needUpdate = true;
        }
        
        ball.style.left = state.x + 'px';
        ball.style.top = state.y + 'px';
    });
    
    if (needUpdate) {
        requestAnimationFrame(update);
    }
}
</script>
</body>
</html>